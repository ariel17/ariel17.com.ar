<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="es">
<head>
<meta charset="utf-8">
<base href="http://ariel17.com.ar/categories/python/">
<meta name="viewport" content="width=device-width">
<title>Publicaciones sobre python | Ariel Gerardo Ríos</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS for tag python (es)" href="../python.xml">
<link rel="canonical" href="http://ariel17.com.ar/categories/python/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ir al contenido principal</a>
    <div id="container">
         
    <header id="header"><nav class="navbar navbar-inverse navbar-fixed-top"><div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="collapsed navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="#" class="navbar-brand">Ariel Gerardo Ríos</a>
      </div>
      <div class="collapse navbar-collapse" id="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
<li id="home-link"><a href="../../">Home</a></li>
                <li><a href="../../blog">Blog</a></li>
                <li><a href="../../projects">Proyectos</a></li>
          
          
        </ul>
</div>
    </div>
  </nav></header><main id="content"><div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../../blog/refreshing-tokens-on-django-for-google-oauth2-the-hard-way/" class="u-url">Renovando tokens en Django para Google Oauth2, de la manera difícil</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Ariel Gerardo Ríos</span></p>
            <p class="dateline"><a href="../../blog/refreshing-tokens-on-django-for-google-oauth2-the-hard-way/" rel="bookmark"><time class="published dt-published" datetime="2014-10-30T10:00:16-03:00" title="2014-10-30 10:00">2014-10-30 10:00</time></a></p>
                <p class="commentline">
        
    <a href="../../blog/refreshing-tokens-on-django-for-google-oauth2-the-hard-way/#disqus_thread" data-disqus-identifier="cache/posts/refreshing-tokens-on-django-for-google-oauth2-the-hard-way.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Cuando digo <em>de la manera difícil</em> quiero decir que fue MUY difícil <em>para mí</em>
encontrar la combinación correcta de configuraciones para tener funcionando
<a class="reference external" href="https://www.djangoproject.com/">Django</a> combinado con <a class="reference external" href="http://psa.matiasaguirre.net/">python-social-auth</a> y <a class="reference external" href="https://developers.google.com/api-client-library/python/">google-api-python-client</a>. El
escenario era tan simple y sin embargo tan complicado de hacerlo funcionar como
debía, que estoy un poco frustrado.</p>
<div class="section" id="el-escenario">
<h2>El escenario</h2>
<p>Sincronizar un evento propio del usuario hacia su cuenta de Google Calendar, no
en ambas direcciones sino sólo <code>Django -&gt; GCalendar</code>. El usuario debe
autenticar la cuenta para usar la sincronización sólo una vez, pero los tokens
de <a class="reference external" href="https://developers.google.com/accounts/docs/OAuth2">Google Oauth2</a> tienen 1 hora de tiempo de vida, así que tienen que ser
renovados o solicitarle al usuario que autorice la aplicación nuevamente.
Ningún dato del usuario se debe actualizar.</p>
</div>
<div class="section" id="el-ambiente-django">
<h2>El ambiente Django</h2>
<p>Google ya cuenta con la biblioteca <a class="reference external" href="https://developers.google.com/api-client-library/python/">google-api-python-client</a> para facilitar la
implementación de los flujos de autenticación pero yo quise usar una biblioteca
que tiene una manera más elegante de hacerlo: <a class="reference external" href="http://psa.matiasaguirre.net/">python-social-auth</a>. Este úlltimo
también permite hacer uso de <a class="reference external" href="http://psa.matiasaguirre.net/docs/backends/index.html#social-backends">muchos otros backends</a> muy fácilmente, no sólo
Google y <a class="reference external" href="http://psa.matiasaguirre.net/docs/backends/index.html#non-social-backends">no sólo sociales</a>. Así que esto es lo que tengo:</p>
<pre class="code text"><a name="rest_code_027739845ee34c219866ae39cece9e58-1"></a># Requerimientos
<a name="rest_code_027739845ee34c219866ae39cece9e58-2"></a>Django==1.7
<a name="rest_code_027739845ee34c219866ae39cece9e58-3"></a>python-social-auth==0.2.1
<a name="rest_code_027739845ee34c219866ae39cece9e58-4"></a>google-api-python-client==1.2
<a name="rest_code_027739845ee34c219866ae39cece9e58-5"></a>raven==5.0.0  # *realmente* deberia tener Sentry! https://getsentry.com/
<a name="rest_code_027739845ee34c219866ae39cece9e58-6"></a>requests==2.3.0
</pre>
<p>Y las configuraciones relacionadas en <code>settings.py</code>:</p>
<pre class="code python"><a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-1"></a><span class="c"># project/settings.py</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-2"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-3"></a><span class="n">AUTHENTICATION_BACKENDS</span> <span class="o">=</span> <span class="p">(</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-4"></a>    <span class="s">'social.backends.google.GoogleOAuth2'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-5"></a>    <span class="s">'django.contrib.auth.backends.ModelBackend'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-6"></a><span class="p">)</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-7"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-8"></a><span class="n">SOCIAL_AUTH_LOGIN_REDIRECT_URL</span> <span class="o">=</span> <span class="s">'/home/'</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-9"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-10"></a><span class="n">SOCIAL_AUTH_LOGIN_ERROR_URL</span> <span class="o">=</span> <span class="n">SOCIAL_AUTH_LOGIN_REDIRECT_URL</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-11"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-12"></a><span class="n">SOCIAL_AUTH_DISCONNECT_REDIRECT_URL</span> <span class="o">=</span> <span class="n">SOCIAL_AUTH_LOGIN_REDIRECT_URL</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-13"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-14"></a><span class="n">SOCIAL_AUTH_GOOGLE_OAUTH2_SCOPE</span> <span class="o">=</span> <span class="p">[</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-15"></a>    <span class="s">'https://www.googleapis.com/auth/calendar'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-16"></a><span class="p">]</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-17"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-18"></a><span class="n">SOCIAL_AUTH_GOOGLE_OAUTH2_AUTH_EXTRA_ARGUMENTS</span> <span class="o">=</span> <span class="p">{</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-19"></a>    <span class="s">'access_type'</span><span class="p">:</span> <span class="s">'offline'</span><span class="p">,</span>  <span class="c"># Activa el permiso de renovación</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-20"></a>    <span class="s">'approval_promt'</span><span class="p">:</span> <span class="s">'force'</span>  <span class="c"># Activa refresh_token</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-21"></a><span class="p">}</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-22"></a>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-23"></a><span class="n">SOCIAL_AUTH_PIPELINE</span> <span class="o">=</span> <span class="p">(</span>  <span class="c"># Quitado creación de usuario y actualización del perfil</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-24"></a>    <span class="s">'social.pipeline.social_auth.social_details'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-25"></a>    <span class="s">'social.pipeline.social_auth.social_uid'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-26"></a>    <span class="s">'social.pipeline.social_auth.auth_allowed'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-27"></a>    <span class="s">'social.pipeline.social_auth.associate_user'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-28"></a>    <span class="s">'social.pipeline.social_auth.load_extra_data'</span><span class="p">,</span>
<a name="rest_code_59d3fd63f4f44eb49e27f470ce3234ab-29"></a><span class="p">)</span>
</pre>
<p>Lo que hace toda la magia es el argumento extra <code>approval_promt</code> porque
Google sólo envía el <code>refresh_token</code> cuando está presente. No importa el
hecho de que uno ya indicó el tipo de acceso offline: cuando el momento de la
renovación llegue uno sólo puede hacerlo usando ese valor, ningún otro es
válido. <strong>Por favor, refútenme.</strong></p>
</div>
<div class="section" id="sincronizando-y-renovando">
<h2>Sincronizando y renovando</h2>
<p>Un modelo que representa un evento de usario con sincronización + renovación
del token cuando sucede un error de autenticación:</p>
<pre class="code python"><a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-1"></a><span class="c">#!/usr/bin/env python</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-2"></a><span class="c"># -*- coding: utf-8 -*-</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-3"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-4"></a><span class="sd">"""</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-5"></a><span class="sd">Model definition for appliation ``app``.</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-6"></a><span class="sd">"""</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-7"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-8"></a><span class="kn">import</span> <span class="nn">logging</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-9"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-10"></a><span class="kn">from</span> <span class="nn">apiclient.discovery</span> <span class="kn">import</span> <span class="n">build</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-11"></a><span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">AccessTokenCredentials</span><span class="p">,</span> <span class="n">AccessTokenCredentialsError</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-12"></a><span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-13"></a><span class="kn">import</span> <span class="nn">httplib2</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-14"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-15"></a><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-16"></a><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-17"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-18"></a><span class="kn">from</span> <span class="nn">social.apps.django_app.default.models</span> <span class="kn">import</span> <span class="n">UserSocialAuth</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-19"></a><span class="kn">from</span> <span class="nn">social.apps.django_app.utils</span> <span class="kn">import</span> <span class="n">load_strategy</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-20"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-21"></a><span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Event</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-22"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-23"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-24"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-25"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-26"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-27"></a><span class="k">class</span> <span class="nc">CustomEvent</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-28"></a>    <span class="sd">"""</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-29"></a><span class="sd">    A very simple custom event model.</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-30"></a><span class="sd">    """</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-31"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-32"></a>    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-33"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-34"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-35"></a>    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-36"></a>        <span class="k">return</span> <span class="s">u"{0} ({1})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-37"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-38"></a>    <span class="k">def</span> <span class="nf">get_google_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-39"></a>        <span class="sd">"""</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-40"></a><span class="sd">        Implementing the Calendar API content required to create an event:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-41"></a><span class="sd">        https://developers.google.com/google-apps/calendar/v3/reference/events?hl=es#resource</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-42"></a><span class="sd">        """</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-43"></a>        <span class="k">return</span> <span class="p">{}</span>  <span class="c"># dummy of course</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-44"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-45"></a>    <span class="k">def</span> <span class="nf">sync_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-46"></a>        <span class="sd">"""</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-47"></a><span class="sd">        Pushes current event to the user's Google Calendar service, if it is enabled.</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-48"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-49"></a><span class="sd">        :param retry: Indicates if it should retry on an authentication error.</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-50"></a><span class="sd">        :type retry: ``bool``</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-51"></a><span class="sd">        :return: Synchronization result from Google API.</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-52"></a><span class="sd">        :rtype: ``dict`` or ``None``</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-53"></a><span class="sd">        """</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-54"></a>        <span class="k">try</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-55"></a>            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">social_auth</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="s">'google-oauth2'</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-56"></a>        <span class="k">except</span> <span class="n">UserSocialAuth</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-57"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u"Google is not authenticated; nothing to do :("</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-58"></a>            <span class="k">return</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-59"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-60"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u'Syncronizing event </span><span class="si">%r</span><span class="s"> into Google Calendar for user </span><span class="si">%r</span><span class="s">'</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-61"></a>                     <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-62"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-63"></a>        <span class="n">credentials</span> <span class="o">=</span> <span class="n">AccessTokenCredentials</span><span class="p">(</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-64"></a>            <span class="n">provider</span><span class="o">.</span><span class="n">extra_data</span><span class="p">[</span><span class="s">'access_token'</span><span class="p">],</span> <span class="s">'my-user-agent/1.0'</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-65"></a>        <span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-66"></a>        <span class="n">http</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">()</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-67"></a>        <span class="n">http</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-68"></a>        <span class="n">service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="n">serviceName</span><span class="o">=</span><span class="s">'calendar'</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">'v3'</span><span class="p">,</span> <span class="n">http</span><span class="o">=</span><span class="n">http</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-69"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-70"></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_google_data</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-71"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u'Creating event with data: </span><span class="si">%r</span><span class="s">'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-72"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-73"></a>        <span class="k">try</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-74"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">events</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-75"></a>                <span class="n">calendarId</span><span class="o">=</span><span class="s">'primary'</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">data</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-76"></a>            <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-77"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-78"></a>        <span class="k">except</span> <span class="n">AccessTokenCredentialsError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-79"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-80"></a>            <span class="k">try</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-81"></a>                <span class="n">provider</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">(</span><span class="n">load_strategy</span><span class="p">())</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-82"></a>            <span class="k">except</span> <span class="n">HTTPError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-83"></a>                <span class="n">provider</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-84"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-85"></a>                    <span class="s">u"Error trying to refesh token. Authorization object "</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-86"></a>                    <span class="s">"was removed."</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-87"></a>                        <span class="s">u'response'</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-88"></a>                            <span class="s">u'body'</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-89"></a>                            <span class="s">u'url'</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-90"></a>                            <span class="s">u'status_code'</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-91"></a>                        <span class="p">},</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-92"></a>                        <span class="s">u'request'</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-93"></a>                            <span class="s">u'url'</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-94"></a>                            <span class="s">u'method'</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-95"></a>                            <span class="s">u'body'</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-96"></a>                        <span class="p">},</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-97"></a>                    <span class="p">})</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-98"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-99"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-100"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-101"></a>                <span class="s">u'[sync_event] Unexpected exception synchronizing event'</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-102"></a>                <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-103"></a>                    <span class="s">u'user'</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-104"></a>                        <span class="s">u'pk'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-105"></a>                        <span class="s">u'email'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-106"></a>                    <span class="p">},</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-107"></a>                    <span class="s">u'provider'</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-108"></a>                        <span class="s">u'pk'</span><span class="p">:</span> <span class="n">provider</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-109"></a>                        <span class="s">u'extra_data'</span><span class="p">:</span> <span class="n">provider</span><span class="o">.</span><span class="n">extra_data</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-110"></a>                    <span class="p">},</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-111"></a>                    <span class="s">u'event'</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-112"></a>                        <span class="s">u'pk'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-113"></a>                        <span class="s">u'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-114"></a>                    <span class="p">},</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-115"></a>                <span class="p">})</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-116"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-117"></a>        <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-118"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_event</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-119"></a>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-120"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">u'Event creation result: </span><span class="si">%r</span><span class="s">'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a name="rest_code_5a62c5ca531948e5bd64635ffa75eaf9-121"></a>        <span class="k">return</span> <span class="n">result</span>
</pre>
<p>¡Buen fin de semana! :)</p>
<p><strong>ACTUALIZACIÓN del 2014-11-11:</strong> <a class="reference external" href="http://psa.matiasaguirre.net/">python-social-auth</a> ha actualizado la
documentación acerca de cómo renovar tokens: <a class="reference external" href="http://psa.matiasaguirre.net/docs/use_cases.html#re-prompt-google-oauth2-users-to-refresh-the-refresh-token">http://psa.matiasaguirre.net/docs/use_cases.html#re-prompt-google-oauth2-users-to-refresh-the-refresh-token</a></p>
<p>Hoy encontré que los refresh_tokens también expiran, así que el valor correcto
de <tt class="docutils literal">approval_promt</tt> a usar es <tt class="docutils literal">auto</tt>:</p>
<pre class="code python"><a name="rest_code_b9beb51270ee4f3ca798a135ec71adeb-1"></a><span class="n">SOCIAL_AUTH_GOOGLE_OAUTH2_AUTH_EXTRA_ARGUMENTS</span> <span class="o">=</span> <span class="p">{</span>
<a name="rest_code_b9beb51270ee4f3ca798a135ec71adeb-2"></a>    <span class="s">'access_type'</span><span class="p">:</span> <span class="s">'offline'</span><span class="p">,</span> <span class="c"># Activa el permiso de renovación</span>
<a name="rest_code_b9beb51270ee4f3ca798a135ec71adeb-3"></a>    <span class="s">'approval_promt'</span><span class="p">:</span> <span class="s">'auto'</span>  <span class="c"># Activa refresh_token, por siempre y para siempre</span>
<a name="rest_code_b9beb51270ee4f3ca798a135ec71adeb-4"></a><span class="p">}</span>
</pre>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="../../blog/broken-properties/" class="u-url">Broken properties</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Ariel Gerardo Ríos</span></p>
            <p class="dateline"><a href="../../blog/broken-properties/" rel="bookmark"><time class="published dt-published" datetime="2014-07-12T19:56:51-03:00" title="2014-07-12 19:56">2014-07-12 19:56</time></a></p>
                <p class="commentline">
        
    <a href="../../blog/broken-properties/#disqus_thread" data-disqus-identifier="cache/posts/broken-properties.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Ayer estuve peleando un rato largo durante el día tratando de reemplazar un
campo en un modelo de <a class="reference external" href="https://www.djangoproject.com/">Django</a> con <strong>property</strong>. Property es un mecanismo en el
lenguaje <a class="reference external" href="https://www.python.org/">Python</a> para implementar getters y setters de un campo en una clase de
manera transparente (<em>de forma pytónica</em> dirían algunos). Acá un ejemplo
sencillo:</p>
<pre class="code python"><a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-1"></a><span class="c">#!/usr/bin/env python</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-2"></a><span class="c"># -*- coding: utf-8 -*-</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-3"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-4"></a><span class="sd">"""</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-5"></a><span class="sd">File: foo.py</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-6"></a><span class="sd">Description: A very simple property implementation on a very simple class.</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-7"></a><span class="sd">"""</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-8"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-9"></a><span class="kn">import</span> <span class="nn">random</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-10"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-11"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-12"></a><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-13"></a>    <span class="sd">"""</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-14"></a><span class="sd">    This is a foo class implementation.</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-15"></a><span class="sd">    """</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-16"></a>    <span class="n">_foo</span> <span class="o">=</span> <span class="mi">1</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-17"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-18"></a>    <span class="nd">@property</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-19"></a>    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-20"></a>        <span class="sd">"""</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-21"></a><span class="sd">        Access the _foo field but doing some dummy calculations.</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-22"></a><span class="sd">        """</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-23"></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foo</span><span class="p">)</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-24"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-25"></a>    <span class="nd">@foo.setter</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-26"></a>    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-27"></a>        <span class="sd">"""</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-28"></a><span class="sd">        Setter for _foo field but doing some "validations".</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-29"></a><span class="sd">        """</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-30"></a>        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-31"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">"foo field cannot be greater than 10"</span><span class="p">)</span>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-32"></a>
<a name="rest_code_bc82c1b3a64f47e79c655d99a13d2c57-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_foo</span> <span class="o">=</span> <span class="n">value</span>
</pre>
<p>Así se usaría la clase <tt class="docutils literal">Foo</tt> recién implementada:</p>
<pre class="code bash"><a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-1"></a>~<span class="nv">$ </span>python
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-2"></a>&gt;&gt;&gt; from foo import Foo
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-3"></a>&gt;&gt;&gt; <span class="nv">f</span> <span class="o">=</span> Foo<span class="o">()</span>
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-4"></a>&gt;&gt;&gt; f._foo  <span class="c"># _foo field is still accessible</span>
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-5"></a>1
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-6"></a>&gt;&gt;&gt; f.foo
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-7"></a>1
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-8"></a>&gt;&gt;&gt; f._foo <span class="o">==</span> f.foo
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-9"></a>True
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-10"></a>&gt;&gt;&gt; f.foo  <span class="c"># since f._foo == 1, random will only return 1</span>
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-11"></a>1
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-12"></a>&gt;&gt;&gt; f.foo <span class="o">=</span> 5
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-13"></a>&gt;&gt;&gt; f.foo  <span class="c"># now f._foo == 5; random numbers will vary between 1 and 5</span>
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-14"></a>3
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-15"></a>&gt;&gt;&gt; f.foo <span class="o">=</span> <span class="m">20</span>  <span class="c"># this will raise a ValueError exception</span>
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-16"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-17"></a>  File <span class="s2">"&lt;stdin&gt;"</span>, line 1, in &lt;module&gt;
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-18"></a>  File <span class="s2">"foo.py"</span>, line 31, in foo
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-19"></a>    raise ValueError<span class="o">(</span><span class="s2">"foo field cannot be greater than 10"</span><span class="o">)</span>
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-20"></a>ValueError: foo field cannot be greater than 10
<a name="rest_code_8ce8cb66f80a42639acc4a4b0f4bb2d5-21"></a>&gt;&gt;&gt;
</pre>
<p><a class="reference external" href="https://docs.python.org/2/library/functions.html#property">Acá se puede leer la documentación oficial</a> acerca de esta funcionalidad.</p>
<div class="section" id="el-problema-con-django">
<h2>El problema con Django</h2>
<p>Implementar esta funcionalidad en <a class="reference external" href="https://www.djangoproject.com/">Django</a> para los campos de un modelo no es un
problema en absoluto. El problema reside en querer utilizar las demás ventajas
que ofrece el framework sobre el campo en el que se utilizó esta solución. Voy
a ejemplificarlo con un proyecto muy simple:</p>
<pre class="code bash"><a name="rest_code_62e0ecfd89d144769961113d7823cba8-1"></a>~<span class="nv">$ </span>sudo apt-get install python-pip <span class="o">&amp;&amp;</span> sudo pip install virtualenv
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-2"></a>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-3"></a>... <span class="o">(</span>skipped output<span class="o">)</span>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-4"></a>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-5"></a>~<span class="nv">$ </span>mkdir brokenprop <span class="o">&amp;&amp;</span> <span class="nb">cd </span>brokenprop
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-6"></a>~/brokenprop<span class="nv">$ </span>virtualenv env
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-7"></a>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-8"></a>... <span class="o">(</span>skipped output<span class="o">)</span>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-9"></a>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-10"></a><span class="o">(</span>env<span class="o">)</span>~/brokenprop<span class="nv">$ </span>pip install django
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-11"></a>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-12"></a>... <span class="o">(</span>skipped more output<span class="o">)</span>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-13"></a>
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-14"></a><span class="o">(</span>env<span class="o">)</span>~/brokenprop<span class="nv">$ </span>django-admin.py startproject brokenprop <span class="o">&amp;&amp;</span> <span class="nb">cd </span>brokenprop
<a name="rest_code_62e0ecfd89d144769961113d7823cba8-15"></a><span class="o">(</span>env<span class="o">)</span>~/brokenprop/brokenprop<span class="nv">$ </span>chmod +x manage.py <span class="o">&amp;&amp;</span> ./manage.py startapp propapp
</pre>
<p>El proyecto de pruebas ya está inicializado. Por defecto <a class="reference external" href="https://www.djangoproject.com/">Django</a> trae
configurado <a class="reference external" href="http://www.sqlite.org/">SQLite</a> como base de datos y para este ejemplo es más que
suficiente. Voy a editar el módulo de modelos de la aplicación <tt class="docutils literal">proapp</tt> e
implementar setter y getter en una clase. El resultado es muy similar al
ejemplo anterior:</p>
<pre class="code python"><a name="rest_code_53749e011c02472d9e6cda6d7803a05b-1"></a><span class="c">#!/usr/bin/env python</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-2"></a><span class="c"># -*- coding: utf-8 -*-</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-3"></a>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-4"></a><span class="sd">"""</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-5"></a><span class="sd">File: models.py</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-6"></a><span class="sd">Description: Model implementations for application 'propapp'.</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-7"></a><span class="sd">"""</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-8"></a>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-9"></a><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-10"></a>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-11"></a>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-12"></a><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-13"></a>    <span class="sd">"""</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-14"></a><span class="sd">    A foo model implementation.</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-15"></a><span class="sd">    """</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-16"></a>    <span class="n">_foo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-17"></a>        <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-18"></a>        <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-19"></a>        <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-20"></a>        <span class="n">db_column</span><span class="o">=</span><span class="s">'foo'</span><span class="p">,</span>  <span class="c"># keeps the field name as it should</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-21"></a>    <span class="p">)</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-22"></a>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-23"></a>    <span class="nd">@property</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-24"></a>    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-25"></a>        <span class="sd">"""</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-26"></a><span class="sd">        The foo getter</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-27"></a><span class="sd">        """</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-28"></a>        <span class="c"># doing the things that a getter method does ...</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foo</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-30"></a>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-31"></a>    <span class="nd">@foo.setter</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-32"></a>    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-33"></a>        <span class="c"># doing the things that a setter method does ...</span>
<a name="rest_code_53749e011c02472d9e6cda6d7803a05b-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_foo</span> <span class="o">=</span> <span class="n">value</span>
</pre>
<p>Ya tengo el modelo con un campo y sus respectivos métodos. Así debería usarlos:</p>
<pre class="code bash"><a name="rest_code_6f573bd81f174078acae1872b1ed5022-1"></a><span class="o">(</span>env<span class="o">)</span>~/brokenprop/brokenprop<span class="nv">$ </span>./manage.py syncdb --noinput
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-2"></a>
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-3"></a>... <span class="o">(</span>skipped output <span class="k">for</span> sync stuff<span class="o">)</span> ...
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-4"></a>
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-5"></a><span class="o">(</span>env<span class="o">)</span>~/brokenprop/brokenprop<span class="nv">$ </span>./manage.py shell
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-6"></a>
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-7"></a>&gt;&gt;&gt; from propapp.models import Foo
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-8"></a>&gt;&gt;&gt; <span class="nv">f</span> <span class="o">=</span> Foo<span class="o">()</span>
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-9"></a>&gt;&gt;&gt; f.foo <span class="o">=</span> <span class="s1">'a'</span>
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-10"></a>&gt;&gt;&gt; f._foo
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-11"></a><span class="s1">'a'</span>
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-12"></a>&gt;&gt;&gt; f._foo <span class="o">==</span> f.foo
<a name="rest_code_6f573bd81f174078acae1872b1ed5022-13"></a>True
</pre>
<p>Todo muy bien hasta acá; es más, todo es igual, sin problemas. Los problemas
comienzan cuando se quiere usar el campo en una query:</p>
<pre class="code bash"><a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-1"></a>&gt;&gt;&gt; Foo.objects.filter<span class="o">(</span><span class="nv">foo</span><span class="o">=</span><span class="s1">'bar'</span><span class="o">)</span>
<a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-2"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-3"></a>...
<a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-4"></a>File <span class="s2">"/home/ariel17/brokenprop/env/local/lib/python2.7/site-packages/django/db/models/sql/query.py"</span>, line 1283, in names_to_path
<a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-5"></a>  <span class="s2">"Choices are: %s"</span> % <span class="o">(</span>name, <span class="s2">", "</span>.join<span class="o">(</span>available<span class="o">)))</span>
<a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-6"></a>FieldError: Cannot resolve keyword <span class="s1">'foo'</span> into field. Choices are: _foo, id
<a name="rest_code_f666ce85fe624050ab143c09a95d5e6f-7"></a>&gt;&gt;&gt;
</pre>
<p>Bien, no puedo usar el campo tal como lo debería usar <tt class="docutils literal">:(</tt>. Supongamos
que asumo este costo y quiero continuar así, no me importa que el nombre
del campo en las queries no sea el evidente e intuitivo, sino que usaré el
nombre que le puse con el prefijo <tt class="docutils literal">_</tt> o lo que se requiera para acceder a
él:</p>
<pre class="code bash"><a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-1"></a>&gt;&gt;&gt; Foo.objects.filter<span class="o">(</span><span class="nv">_foo</span><span class="o">=</span><span class="s1">'bar'</span><span class="o">)</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-2"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-3"></a>...
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-4"></a>File <span class="s2">"/home/ariel17/brokenprop/env/local/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py"</span>, line 451, in execute
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-5"></a>  <span class="k">return</span> Database.Cursor.execute<span class="o">(</span>self, query, params<span class="o">)</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-6"></a>OperationalError: no such table: propapp_foo
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-7"></a>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-8"></a>&gt;&gt;&gt; Foo.objects.filter<span class="o">(</span><span class="nv">__foo</span><span class="o">=</span><span class="s1">'bar'</span><span class="o">)</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-9"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-10"></a>...
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-11"></a>File <span class="s2">"/home/ariel17/brokenprop/env/local/lib/python2.7/site-packages/django/db/models/sql/query.py"</span>, line 1283, in names_to_path
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-12"></a>  <span class="s2">"Choices are: %s"</span> % <span class="o">(</span>name, <span class="s2">", "</span>.join<span class="o">(</span>available<span class="o">)))</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-13"></a>FieldError: Cannot resolve keyword <span class="s1">''</span> into field. Choices are: _foo, id
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-14"></a>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-15"></a>&gt;&gt;&gt; Foo.objects.filter<span class="o">(</span><span class="nv">propapp__foo</span><span class="o">=</span><span class="s1">'bar'</span><span class="o">)</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-16"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-17"></a>...
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-18"></a>File <span class="s2">"/home/ariel17/brokenprop/env/local/lib/python2.7/site-packages/django/db/models/sql/query.py"</span>, line 1283, in names_to_path
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-19"></a>  <span class="s2">"Choices are: %s"</span> % <span class="o">(</span>name, <span class="s2">", "</span>.join<span class="o">(</span>available<span class="o">)))</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-20"></a>FieldError: Cannot resolve keyword <span class="s1">'propapp'</span> into field. Choices are: _foo, id
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-21"></a>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-22"></a>&gt;&gt;&gt; Foo.objects.filter<span class="o">(</span><span class="nv">propapp_foo</span><span class="o">=</span><span class="s1">'bar'</span><span class="o">)</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-23"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-24"></a>...
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-25"></a>File <span class="s2">"/home/ariel17/brokenprop/env/local/lib/python2.7/site-packages/django/db/models/sql/query.py"</span>, line 1283, in names_to_path
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-26"></a>  <span class="s2">"Choices are: %s"</span> % <span class="o">(</span>name, <span class="s2">", "</span>.join<span class="o">(</span>available<span class="o">)))</span>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-27"></a>FieldError: Cannot resolve keyword <span class="s1">'propapp_foo'</span> into field. Choices are: _foo, id
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-28"></a>
<a name="rest_code_802a1280c59c43f989b326d0a85cd7a0-29"></a>&gt;&gt;&gt;
</pre>
<p><strong>El campo está inaccesible para usarlo en queries</strong>. El issue <a class="reference external" href="https://code.djangoproject.com/ticket/3148">#3148</a> del
track de <a class="reference external" href="https://www.djangoproject.com/">Django</a> habla al respecto, pero la solución planteada, en la que está
basada este post, no provee la funcionalidad esperada (<a class="reference external" href="https://code.djangoproject.com/ticket/3148#comment:51">mis quejas aquí</a>).</p>
<p>Salvo, claro, que <strong>me esté perdiendo algo</strong>.</p>
</div>
</div>
    </div>
    </article>
</div>



        
       <script>var disqus_shortname="ariel17";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script></main><footer id="footer"><p>Contents © 2018         <a href="mailto:ariel.gerardo.rios@gmail.com">Ariel Gerardo Ríos</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    
    
    <script src="../../assets/js/bootstrap.min.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48346337-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
